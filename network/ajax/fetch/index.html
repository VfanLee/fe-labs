<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fetch API 示例</title>
  </head>
  <body>
    <section>
      <button id="get-user-list">用户列表</button>
      <button id="get-single-user">单用户</button>
      <button id="create-user">创建用户</button>
      <button id="update-user">更新用户</button>
      <button id="delete-user">删除用户</button>
      <button id="create-user-formdata">创建用户（formdata）</button>
      <button id="file-upload">文件上传</button>
    </section>

    <input type="file" id="hidden-file-input" style="display: none" />

    <script>
      const baseUrl = 'https://reqres.in/api';
      const defaultHeaders = {
        'x-api-key': 'reqres-free-v1',
        'Content-Type': 'application/json',
      };

      // 通用请求函数
      async function makeRequest(method, url, data = null, headers = {}) {
        const options = {
          method,
          headers: { ...defaultHeaders, ...headers },
        };

        if (data) {
          options.body = data instanceof FormData ? data : JSON.stringify(data);
          if (data instanceof FormData) {
            // 删除Content-Type让浏览器自动设置multipart/form-data和boundary
            delete options.headers['Content-Type'];
          }
        }

        try {
          const response = await fetch(url, options);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          // DELETE请求可能没有响应体
          if (method === 'DELETE') return null;

          return await response.json();
        } catch (error) {
          console.error('请求失败:', error);
          throw error;
        }
      }

      // 用户列表 (GET)
      document.getElementById('get-user-list').addEventListener('click', async () => {
        try {
          const response = await makeRequest('GET', baseUrl + '/users?page=2');
          console.log('用户列表:', response);
        } catch (error) {
          console.error('获取用户列表失败:', error);
        }
      });

      // 单用户 (GET)
      document.getElementById('get-single-user').addEventListener('click', async () => {
        try {
          const response = await makeRequest('GET', baseUrl + '/users/2');
          console.log('单用户:', response);
        } catch (error) {
          console.error('获取单用户失败:', error);
        }
      });

      // 创建用户 (POST)
      document.getElementById('create-user').addEventListener('click', async () => {
        try {
          const data = {
            name: 'morpheus',
            job: 'leader',
          };
          const response = await makeRequest('POST', baseUrl + '/users', data);
          console.log('创建用户:', response);
        } catch (error) {
          console.error('创建用户失败:', error);
        }
      });

      // 更新用户 (PUT)
      document.getElementById('update-user').addEventListener('click', async () => {
        try {
          const data = {
            name: 'morpheus',
            job: 'zion resident',
          };
          const response = await makeRequest('PUT', baseUrl + '/users/2', data);
          console.log('更新用户:', response);
        } catch (error) {
          console.error('更新用户失败:', error);
        }
      });

      // 删除用户 (DELETE)
      document.getElementById('delete-user').addEventListener('click', async () => {
        try {
          await makeRequest('DELETE', baseUrl + '/users/2');
          console.log('删除用户成功');
        } catch (error) {
          console.error('删除用户失败:', error);
        }
      });

      // 使用FormData创建用户 (POST)
      document.getElementById('create-user-formdata').addEventListener('click', async () => {
        try {
          const formData = new FormData();
          formData.append('name', 'morpheus');
          formData.append('job', 'leader');

          const response = await makeRequest('POST', baseUrl + '/users', formData);
          console.log('使用FormData创建用户:', response);
        } catch (error) {
          console.error('使用FormData创建用户失败:', error);
        }
      });

      // 文件上传
      document.getElementById('file-upload').addEventListener('click', () => {
        const fileInput = document.getElementById('hidden-file-input');
        fileInput.click();

        fileInput.addEventListener('change', async function () {
          const file = this.files[0];

          if (!file) {
            console.log('没有选择文件');
            return;
          }

          console.log('准备上传文件:', file.name);

          const formData = new FormData();
          formData.append('file', file);

          try {
            // 创建新的AbortController用于取消请求
            const controller = new AbortController();
            const signal = controller.signal;

            // 设置超时
            const timeoutId = setTimeout(() => {
              controller.abort();
              console.log('请求超时');
            }, 5000);

            // 上传进度监控
            const response = await fetch('https://httpbin.org/post', {
              method: 'POST',
              headers: {
                'x-api-key': 'reqres-free-v1',
              },
              body: formData,
              signal,
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            console.log('文件上传成功:', result);
            alert(`文件 "${file.name}" 上传成功（模拟）`);
            fileInput.value = ''; // 清空文件输入
          } catch (error) {
            if (error.name === 'AbortError') {
              console.error('请求被取消:', error);
            } else {
              console.error('文件上传失败:', error);
            }
          }
        });
      });
    </script>
  </body>
</html>
